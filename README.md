# Example Flask Application 

This repo holds an example Python/Flask application that uses FusionAuth as the identity provider. 
This application will use an OAuth Device Code Grant workflow to log a user in and get them access and 
refresh tokens across devices.

The first scenario is if you have a logged in phone and a logged out computer. The phone scans a QR code generated by the computer on a public page, and then after the user submits the user code, the laptop is logged in.

This application was built on top of the [Python/Flask Quickstart](https://fusionauth.io/docs/quickstarts/quickstart-python-flask-web).

## Project Contents

The `docker-compose.yml` file and the `kickstart` directory are used to start and configure a local FusionAuth server.

The `/complete-application` directory contains a fully working version of the application.

## Project Dependencies
* Docker, for running FusionAuth
* Python 3.8 or later, for running the Changebank Python application
* ngrok for multi-device access

## Running Ngrok

To run the application, first set up ngrok. You'll need two different ngrok servers, one for the flask app and one for the FusionAuth server. This is because both need to be accessible from your mobile device.

These instructions are for users with a free ngrok account.

Add these to your ngrok.yml file:

```
tunnels:
  fa:
    proto: http
    addr: 9011
  flask:
    proto: http
    addr: 5000
```

You can find out where your config file lives by reading the ngrok doc: https://ngrok.com/docs/agent/config/ 

Now, start up the two servers by running

```shell
ngrok start --all
```

You'll see some output, but the important section looks like this:

```
Forwarding                    https://9184-73-249-72-110.ngrok-free.app -> http://localhost:5000
Forwarding                    https://b27b-73-249-72-110.ngrok-free.app -> http://localhost:9011
```

You will need the forwarding URLs below.

## Running FusionAuth

Update the `variables` section of `kickstart/kickstart.json`. Modify the `app_url` and `issuer_url` values to point to your ngrok URLs. The `app_url` is what forwards to port 5000 (the flask app) and the `issuer_url` is what forwards to port 9011 (the FusionAuth app).

Then, to run FusionAuth, stand up the docker containers using `docker-compose`.

```shell
docker-compose up
```

This will start a PostgreSQL database, and Elastic service, and the FusionAuth server.

## Running the Example App

Set up a Python virtual env and installing the project dependencies.

```shell
python -m venv venv && \
source venv/bin/activate && \
pip install -r requirements.txt
```

Then use the `python` command to start up the application.

```shell
python server.py
```

Using `flask` to start the application will not work because of threading.

Visit the local webserver at the ngrok URL from your phone and sign in using the credentials:

* username: richard@example.com
* password: password

Then, visit the local webserver at the ngrok URL from your laptop. Click on the 'Log In Using Mobile Device' link. 

Scan the QR code with your phone, and complete the device grant.

You should be logged in on the laptop.

## Logging In On Phone From Laptop

If you are in the other scenario, where you are logged in on the laptop but want to log in on the phone, this example will partially work for you. This flow does NOT COMPLETELY WORK, but is left as an example if you are using a different auth library.

If you log in on the laptop, you'll see a link to 'Log In On Mobile Device'. This will present a QR code that can be scanned by your phone. However, due to authlib security restrictions, you'll see this error in the log when you try to visit the URL:

```
authlib.integrations.base_client.errors.MismatchingStateError: mismatching_state: CSRF Warning! State not equal in request and response.
```

This is due to sensible CSRF security protocols that in this case we don't need because:

* FusionAuth already checks to make sure we want to log in, removing the need for the secondary CSRF check
* we want to log in cross device

It is here as an example so that if you use a different library that doesn't check the state twice, you can reuse the concepts.

